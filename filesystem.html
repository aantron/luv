<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="author" title="About these documents" href="about.html" /><link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Networking" href="networking.html" /><link rel="prev" title="Basics" href="basics.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2023.09.10 -->
        <title>Filesystem - Luv documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Luv  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">Luv  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="basics.html">Basics</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="threads.html">Threads</a></li>
<li class="toctree-l1"><a class="reference internal" href="processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="filesystem">
<h1>Filesystem<a class="headerlink" href="#filesystem" title="Link to this heading">#</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The libuv filesystem operations are different from <a class="reference internal" href="networking.html"><span class="doc">socket operations</span></a>. Socket operations use the non-blocking operations provided
by the operating system. Filesystem operations use blocking functions
internally, but invoke these functions in a <a class="reference external" href="http://docs.libuv.org/en/v1.x/threadpool.html#thread-pool-work-scheduling">thread pool</a> and notify
watchers registered with the event loop when they complete.</p>
</div>
<p>All filesystem operations have two forms — <em>synchronous</em> and <em>asynchronous</em>.</p>
<p>Synchronous operations are slightly easier to program with, and are faster,
because they run in the current thread instead of the thread pool (note again:
this is only an issue for filesystem operations, not sockets or pipes). However,
they can block the thread. This can happen, for example, if you use a
synchronous operation to access a network filesystem which is slow or
unavailable. It can also happen locally. So, synchronous operations should not
be used in robust applications or libraries. Synchronous filesystem operations
are found in module <a class="reference external" href="luv/Luv/File/Sync/index.html">Luv.File.Sync</a>.</p>
<p>Asynchronous versions of all the same operations are found in the main module
<a class="reference external" href="luv/Luv/File/index.html">Luv.File</a>. These each take a callback, to which they
pass their result, instead of returning their result directly, as synchronous
operations do.</p>
<p>As already mentioned, asynchronous filesystem operations are slower than
synchronous, because running an asynchronous operation requires communicating
twice with a thread in the libuv thread pool: once to start the operation, and
once more when it is complete. In some cases, you can mitigate this cost by
manually running multiple operations in one request in the thread pool. To do
that, use <a class="reference external" href="luv/Luv/Thread_pool/index.html#val-queue_work">Luv.Thread_pool.queue_work</a>, and run multiple <em>synchronous</em>
operations in the function you pass to it.</p>
<p>Note that this only offers a performance benefit if you run multiple operations.
Running only one operation is equivalent to simply using the asynchronous API —
that’s how the asynchronous API is implemented.</p>
<p>The rest of this chapter sticks to the asynchronous API.</p>
<section id="reading-writing-files">
<h2>Reading/writing files<a class="headerlink" href="#reading-writing-files" title="Link to this heading">#</a></h2>
<p>A file descriptor is obtained by calling <a class="reference external" href="luv/Luv/File/index.html#val-open_">Luv.File.open_</a>:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">open_</span> <span class="o">:</span>
  <span class="o">?</span><span class="n">mode</span><span class="o">:</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="nn">Mode</span><span class="p">.</span><span class="n">t</span> <span class="kt">list</span> <span class="o">-&gt;</span>
  <span class="kt">string</span> <span class="o">-&gt;</span>
  <span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="nn">Open_flag</span><span class="p">.</span><span class="n">t</span> <span class="kt">list</span> <span class="o">-&gt;</span>
  <span class="o">((</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">t</span><span class="o">,</span> <span class="nn">Luv</span><span class="p">.</span><span class="nn">Error</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="n">result</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="kt">unit</span>
</pre></div>
</div>
<p>Despite the verbose signature, usage is simple:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">open_</span> <span class="s2">&quot;foo&quot;</span> <span class="o">[`</span><span class="nc">RDONLY</span><span class="o">]</span> <span class="o">(</span><span class="k">fun</span> <span class="n">result</span> <span class="o">-&gt;</span> <span class="c">(* ... *)</span><span class="o">)</span>
</pre></div>
</div>
<p><a class="reference external" href="luv/Luv/File/Open_flag/index.html#type-t">Luv.File.Open_flag.t</a> and
<a class="reference external" href="luv/Luv/File/Mode/index.html#type-t">Luv.File.Mode.t</a> expose the standard Unix
open flags and file modes, respectively. libuv takes care of converting them to
appropriate values on Windows. <code class="docutils literal notranslate"><span class="pre">mode</span></code> is optional, because it is only used if
<code class="docutils literal notranslate"><span class="pre">open_</span></code> creates the file.</p>
<p>File descriptors are closed using <a class="reference external" href="luv/Luv/File/index.html#val-close">Luv.File.close</a>:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">close</span> <span class="o">:</span> <span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="kt">unit</span><span class="o">,</span> <span class="nn">Luv</span><span class="p">.</span><span class="nn">Error</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="n">result</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</pre></div>
</div>
<p>Finally, reading and writing are done with <a class="reference external" href="luv/Luv/File/index.html#val-read">Luv.File.read</a> and <a class="reference external" href="luv/Luv/File/index.html#val-write">Luv.File.write</a>:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">read</span> <span class="o">:</span>
  <span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span>
  <span class="nn">Luv</span><span class="p">.</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">t</span> <span class="kt">list</span> <span class="o">-&gt;</span>
  <span class="o">((</span><span class="nn">Unsigned</span><span class="p">.</span><span class="nn">Size_t</span><span class="p">.</span><span class="n">t</span><span class="o">,</span> <span class="nn">Luv</span><span class="p">.</span><span class="nn">Error</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="n">result</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="kt">unit</span>

<span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">write</span> <span class="o">:</span>
  <span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span>
  <span class="nn">Luv</span><span class="p">.</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">t</span> <span class="kt">list</span> <span class="o">-&gt;</span>
  <span class="o">((</span><span class="nn">Unsigned</span><span class="p">.</span><span class="nn">Size_t</span><span class="p">.</span><span class="n">t</span><span class="o">,</span> <span class="nn">Luv</span><span class="p">.</span><span class="nn">Error</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="n">result</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="kt">unit</span>
</pre></div>
</div>
<p>Let’s put all this together into a simple implementation of <code class="docutils literal notranslate"><span class="pre">cat</span></code>:</p>
<p class="rubric"><a class="reference external" href="https://github.com/aantron/luv/blob/master/example/cat.ml">cat.ml</a></p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
<span class="hll"><span class="linenos"> 2</span>  <span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">open_</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="o">[`</span><span class="nc">RDONLY</span><span class="o">]</span> <span class="k">begin</span> <span class="k">function</span>
</span><span class="linenos"> 3</span>    <span class="o">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="o">-&gt;</span>
<span class="linenos"> 4</span>      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Error opening file: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">Error</span><span class="p">.</span><span class="n">strerror</span> <span class="n">e</span><span class="o">)</span>
<span class="linenos"> 5</span>    <span class="o">|</span> <span class="nc">Ok</span> <span class="n">file</span> <span class="o">-&gt;</span>
<span class="linenos"> 6</span>      <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Luv</span><span class="p">.</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">1024</span> <span class="k">in</span>
<span class="linenos"> 7</span>
<span class="hll"><span class="linenos"> 8</span>      <span class="k">let</span> <span class="k">rec</span> <span class="n">on_read</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="linenos"> 9</span>        <span class="o">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="o">-&gt;</span>
<span class="linenos">10</span>          <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Read error: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">Error</span><span class="p">.</span><span class="n">strerror</span> <span class="n">e</span><span class="o">)</span>
<span class="linenos">11</span>        <span class="o">|</span> <span class="nc">Ok</span> <span class="n">bytes_read</span> <span class="o">-&gt;</span>
<span class="linenos">12</span>          <span class="k">let</span> <span class="n">bytes_read</span> <span class="o">=</span> <span class="nn">Unsigned</span><span class="p">.</span><span class="nn">Size_t</span><span class="p">.</span><span class="n">to_int</span> <span class="n">bytes_read</span> <span class="k">in</span>
<span class="linenos">13</span>          <span class="k">if</span> <span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span>
<span class="linenos">14</span>            <span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">close</span> <span class="n">file</span> <span class="n">ignore</span>
<span class="linenos">15</span>          <span class="k">else</span>
<span class="hll"><span class="linenos">16</span>            <span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">write</span>
</span><span class="hll"><span class="linenos">17</span>              <span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">stdout</span>
</span><span class="hll"><span class="linenos">18</span>              <span class="o">[</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">sub</span> <span class="n">buffer</span> <span class="o">~</span><span class="n">offset</span><span class="o">:</span><span class="mi">0</span> <span class="o">~</span><span class="n">length</span><span class="o">:</span><span class="n">bytes_read</span><span class="o">]</span>
</span><span class="hll"><span class="linenos">19</span>              <span class="n">on_write</span>
</span><span class="linenos">20</span>
<span class="hll"><span class="linenos">21</span>      <span class="k">and</span> <span class="n">on_write</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="linenos">22</span>        <span class="o">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="o">-&gt;</span>
<span class="linenos">23</span>          <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Write error: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">Error</span><span class="p">.</span><span class="n">strerror</span> <span class="n">e</span><span class="o">)</span>
<span class="linenos">24</span>        <span class="o">|</span> <span class="nc">Ok</span> <span class="o">_</span><span class="n">bytes_written</span> <span class="o">-&gt;</span>
<span class="hll"><span class="linenos">25</span>          <span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">read</span> <span class="n">file</span> <span class="o">[</span><span class="n">buffer</span><span class="o">]</span> <span class="n">on_read</span>
</span><span class="linenos">26</span>
<span class="linenos">27</span>      <span class="k">in</span>
<span class="linenos">28</span>
<span class="hll"><span class="linenos">29</span>      <span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">read</span> <span class="n">file</span> <span class="o">[</span><span class="n">buffer</span><span class="o">]</span> <span class="n">on_read</span>
</span><span class="linenos">30</span>  <span class="k">end</span><span class="o">;</span>
<span class="linenos">31</span>
<span class="linenos">32</span>  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">Loop</span><span class="p">.</span><span class="n">run</span> <span class="bp">()</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">on_write</span></code> is not robust, because we don’t check that the number of bytes
written is actually the number of bytes we requested to write. Fewer bytes
could have been written, in which case we would need to try again to write
the remaining bytes.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Due to the way filesystems and disk drives are configured for performance,
a write that succeeds may not be committed to disk yet.</p>
</div>
</section>
<section id="filesystem-operations">
<h2>Filesystem operations<a class="headerlink" href="#filesystem-operations" title="Link to this heading">#</a></h2>
<p>All the standard filesystem operations like <code class="docutils literal notranslate"><span class="pre">unlink</span></code>, <code class="docutils literal notranslate"><span class="pre">rmdir</span></code>, <code class="docutils literal notranslate"><span class="pre">stat</span></code> are
supported both synchronously and asynchronously. The easiest way to see the full
list, with simplified signatures, is to scroll down through <a class="reference external" href="luv/Luv/File/Sync/index.html">Luv.File.Sync</a>.</p>
</section>
<section id="file-change-events">
<h2>File change events<a class="headerlink" href="#file-change-events" title="Link to this heading">#</a></h2>
<p>All modern operating systems provide APIs to put watches on individual files or
directories and be informed when the files are modified. libuv wraps common
file change notification libraries <a class="footnote-reference brackets" href="#fsnotify" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>, and the wrapper is exposed by
Luv as module <a class="reference external" href="luv/Luv/FS_event/index.html">Luv.FS_event</a>. To demonstrate, let’s
build a simple utility which runs a command whenever any of the watched files
change:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">onchange</span> <span class="o">&lt;</span><span class="n">command</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">file1</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">file2</span><span class="p">]</span> <span class="o">...</span>
</pre></div>
</div>
<p class="rubric"><a class="reference external" href="https://github.com/aantron/luv/blob/master/example/onchange.ml">onchange.ml</a></p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
<span class="linenos"> 2</span>  <span class="k">match</span> <span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="k">with</span>
<span class="linenos"> 3</span>  <span class="o">|</span> <span class="bp">[]</span> <span class="o">|</span> <span class="o">[_]</span> <span class="o">|</span> <span class="o">[_;</span> <span class="o">_]</span> <span class="o">-&gt;</span>
<span class="linenos"> 4</span>    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Usage: onchange &lt;command&gt; &lt;file1&gt; [file2]...&quot;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>  <span class="o">|</span> <span class="o">_::</span><span class="n">command</span><span class="o">::</span><span class="n">files</span> <span class="o">-&gt;</span>
<span class="linenos"> 7</span>    <span class="n">files</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="k">begin</span> <span class="k">fun</span> <span class="n">target</span> <span class="o">-&gt;</span>
<span class="linenos"> 8</span>      <span class="k">let</span> <span class="n">watcher</span> <span class="o">=</span> <span class="nn">Luv</span><span class="p">.</span><span class="nn">FS_event</span><span class="p">.</span><span class="n">init</span> <span class="bp">()</span> <span class="o">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">get_ok</span> <span class="k">in</span>
<span class="linenos"> 9</span>
<span class="hll"><span class="linenos">10</span>      <span class="nn">Luv</span><span class="p">.</span><span class="nn">FS_event</span><span class="p">.</span><span class="n">start</span> <span class="o">~</span><span class="n">recursive</span><span class="o">:</span><span class="bp">true</span> <span class="n">watcher</span> <span class="n">target</span> <span class="k">begin</span> <span class="k">function</span>
</span><span class="linenos">11</span>        <span class="o">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="o">-&gt;</span>
<span class="linenos">12</span>          <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span>
<span class="linenos">13</span>            <span class="s2">&quot;Error watching %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">target</span> <span class="o">(</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">Error</span><span class="p">.</span><span class="n">strerror</span> <span class="n">e</span><span class="o">);</span>
<span class="linenos">14</span>          <span class="n">ignore</span> <span class="o">(</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">FS_event</span><span class="p">.</span><span class="n">stop</span> <span class="n">watcher</span><span class="o">);</span>
<span class="linenos">15</span>          <span class="nn">Luv</span><span class="p">.</span><span class="nn">Handle</span><span class="p">.</span><span class="n">close</span> <span class="n">watcher</span> <span class="n">ignore</span>
<span class="linenos">16</span>
<span class="linenos">17</span>        <span class="o">|</span> <span class="nc">Ok</span> <span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">events</span><span class="o">)</span> <span class="o">-&gt;</span>
<span class="hll"><span class="linenos">18</span>          <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem</span> <span class="o">`</span><span class="nc">RENAME</span> <span class="n">events</span> <span class="k">then</span>
</span><span class="linenos">19</span>            <span class="n">prerr_string</span> <span class="s2">&quot;renamed &quot;</span><span class="o">;</span>
<span class="hll"><span class="linenos">20</span>          <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem</span> <span class="o">`</span><span class="nc">CHANGE</span> <span class="n">events</span> <span class="k">then</span>
</span><span class="linenos">21</span>            <span class="n">prerr_string</span> <span class="s2">&quot;changed &quot;</span><span class="o">;</span>
<span class="linenos">22</span>          <span class="n">prerr_endline</span> <span class="n">file</span><span class="o">;</span>
<span class="linenos">23</span>
<span class="hll"><span class="linenos">24</span>          <span class="k">let</span> <span class="n">exit_status</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="n">command</span> <span class="k">in</span>
</span><span class="linenos">25</span>          <span class="k">if</span> <span class="n">exit_status</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">then</span>
<span class="linenos">26</span>            <span class="nn">Stdlib</span><span class="p">.</span><span class="n">exit</span> <span class="n">exit_status</span>
<span class="linenos">27</span>      <span class="k">end</span>
<span class="linenos">28</span>    <span class="k">end</span><span class="o">;</span>
<span class="linenos">29</span>
<span class="linenos">30</span>  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">Loop</span><span class="p">.</span><span class="n">run</span> <span class="bp">()</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">)</span>
</pre></div>
</div>
<hr class="docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="fsnotify" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>inotify on Linux, FSEvents on Darwin, kqueue on BSDs,
ReadDirectoryChangesW on Windows, event ports on Solaris. Unsupported on Cygwin</p>
</aside>
</aside>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="networking.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Networking</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="basics.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Basics</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2012-2016, Nikhil Marathe, 2014-2020 libuv contributors, 2020-2023 Anton Bachin
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Filesystem</a><ul>
<li><a class="reference internal" href="#reading-writing-files">Reading/writing files</a></li>
<li><a class="reference internal" href="#filesystem-operations">Filesystem operations</a></li>
<li><a class="reference internal" href="#file-change-events">File change events</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>