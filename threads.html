<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="author" title="About these documents" href="about.html" /><link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Processes" href="processes.html" /><link rel="prev" title="Networking" href="networking.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2023.09.10 -->
        <title>Threads - Luv documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Luv  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">Luv  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="basics.html">Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="filesystem.html">Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Networking</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Threads</a></li>
<li class="toctree-l1"><a class="reference internal" href="processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="threads">
<h1>Threads<a class="headerlink" href="#threads" title="Link to this heading">#</a></h1>
<p>Wait a minute! Why threads? Aren’t event loops supposed to be <em>the</em> way to do
web-scale programming? Well… not always. Threads can still be very useful,
though you will have to make use of various synchronization primitives. For
example, one way to bind a library with a blocking API, without risking blocking
your whole program, is to run its functions in threads.</p>
<p>Today, there are two predominant threading APIs: Windows threads and
<a class="reference external" href="http://man7.org/linux/man-pages/man7/pthreads.7.html">pthreads</a> on Unix. libuv’s thread API is a cross-platform
approximation of pthreads, with similar semantics.</p>
<p>libuv threads don’t follow the model of most of the rest of libuv — event loops
and callbacks. Instead, the libuv thread API is more of a direct wrapper over
your system’s threading library. It is a low-level part of libuv, over which
some other parts of libuv are implemented, but which is also exposed for
applications to use.</p>
<p>This means that libuv thread functions can block, the same as functions in
pthreads.</p>
<section id="starting-and-waiting">
<h2>Starting and waiting<a class="headerlink" href="#starting-and-waiting" title="Link to this heading">#</a></h2>
<p>Start a thread using <a class="reference external" href="luv/Luv/Thread/index.html#val-create">Luv.Thread.create</a> and
wait for it to exit using <a class="reference external" href="luv/Luv/Thread/index.html#val-join">Luv.Thread.join</a>:</p>
<p class="rubric"><a class="reference external" href="https://github.com/aantron/luv/blob/master/example/threads.ml">threads.ml</a></p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
<span class="linenos"> 2</span>  <span class="k">let</span> <span class="n">track_length</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">in</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span>  <span class="k">let</span> <span class="k">rec</span> <span class="n">run_tortoise</span> <span class="o">=</span> <span class="k">function</span>
<span class="linenos"> 5</span>    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
<span class="linenos"> 6</span>      <span class="n">print_endline</span> <span class="s2">&quot;Tortoise done running!&quot;</span>
<span class="linenos"> 7</span>    <span class="o">|</span> <span class="n">n</span> <span class="o">-&gt;</span>
<span class="linenos"> 8</span>      <span class="nn">Luv</span><span class="p">.</span><span class="nn">Time</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">2000</span><span class="o">;</span>
<span class="linenos"> 9</span>      <span class="n">print_endline</span> <span class="s2">&quot;Tortoise ran another step&quot;</span><span class="o">;</span>
<span class="linenos">10</span>      <span class="n">run_tortoise</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
<span class="linenos">11</span>  <span class="k">in</span>
<span class="linenos">12</span>
<span class="linenos">13</span>  <span class="k">let</span> <span class="k">rec</span> <span class="n">run_hare</span> <span class="o">=</span> <span class="k">function</span>
<span class="linenos">14</span>    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
<span class="linenos">15</span>      <span class="n">print_endline</span> <span class="s2">&quot;Hare done running!&quot;</span>
<span class="linenos">16</span>    <span class="o">|</span> <span class="n">n</span> <span class="o">-&gt;</span>
<span class="linenos">17</span>      <span class="nn">Luv</span><span class="p">.</span><span class="nn">Time</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">1000</span><span class="o">;</span>
<span class="linenos">18</span>      <span class="n">print_endline</span> <span class="s2">&quot;Hare ran another step&quot;</span><span class="o">;</span>
<span class="linenos">19</span>      <span class="n">run_hare</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
<span class="linenos">20</span>  <span class="k">in</span>
<span class="linenos">21</span>
<span class="linenos">22</span>  <span class="k">let</span> <span class="n">tortoise</span> <span class="o">=</span>
<span class="hll"><span class="linenos">23</span>    <span class="nn">Luv</span><span class="p">.</span><span class="nn">Thread</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">run_tortoise</span> <span class="n">track_length</span><span class="o">)</span>
</span><span class="linenos">24</span>    <span class="o">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">get_ok</span>
<span class="linenos">25</span>  <span class="k">in</span>
<span class="linenos">26</span>
<span class="linenos">27</span>  <span class="k">let</span> <span class="n">hare</span> <span class="o">=</span>
<span class="hll"><span class="linenos">28</span>    <span class="nn">Luv</span><span class="p">.</span><span class="nn">Thread</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">run_hare</span> <span class="n">track_length</span><span class="o">)</span>
</span><span class="linenos">29</span>    <span class="o">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">get_ok</span>
<span class="linenos">30</span>  <span class="k">in</span>
<span class="linenos">31</span>
<span class="hll"><span class="linenos">32</span>  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">Thread</span><span class="p">.</span><span class="n">join</span> <span class="n">tortoise</span><span class="o">);</span>
</span><span class="hll"><span class="linenos">33</span>  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">Thread</span><span class="p">.</span><span class="n">join</span> <span class="n">hare</span><span class="o">)</span>
</span></pre></div>
</div>
<p>Note that this program does not call <a class="reference external" href="luv/Luv/Loop/index.html#val-run">Luv.Loop.run</a>. This is because, again, threading is a separate,
simpler, and lower-level part of libuv.</p>
</section>
<section id="libuv-thread-pool">
<h2>libuv thread pool<a class="headerlink" href="#libuv-thread-pool" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="luv/Luv/Thread_pool/index.html#val-queue_work">Luv.Thread_pool.queue_work</a> can be
used to run functions in threads from libuv’s thread pool, the same thread pool
libuv uses internally for filesystem and DNS requests:</p>
<p class="rubric"><a class="reference external" href="https://github.com/aantron/luv/blob/master/example/thread_pool.ml">thread_pool.ml</a></p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
<span class="hll"><span class="linenos">2</span>  <span class="nn">Luv</span><span class="p">.</span><span class="nn">Thread_pool</span><span class="p">.</span><span class="n">queue_work</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="linenos">3</span>    <span class="nn">Luv</span><span class="p">.</span><span class="nn">Time</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">1000</span><span class="o">;</span>
<span class="linenos">4</span>    <span class="n">print_endline</span> <span class="s2">&quot;Finished&quot;</span><span class="o">)</span>
<span class="linenos">5</span>    <span class="n">ignore</span><span class="o">;</span>
<span class="linenos">6</span>
<span class="linenos">7</span>  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">Loop</span><span class="p">.</span><span class="n">run</span> <span class="bp">()</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">)</span>
</pre></div>
</div>
<p>This can be easier than creating individual threads, because it is not necessary
to keep track of each thread to later call <a class="reference external" href="luv/Luv/Thread/index.html#val-join">Luv.Thread.join</a>. The thread pool requests are registered with a
libuv event loop, so a single call to <a class="reference external" href="luv/Luv/Loop/index.html#val-run">Luv.Loop.run</a> is enough to wait for all of them.</p>
<p>Use <a class="reference external" href="luv/Luv/Thread_pool/index.html#val-set_size">Luv.Thread_pool.set_size</a> to
set the size of the libuv thread pool. This function should be called by
applications (not libraries) as early as possible during their initialization.</p>
</section>
<section id="synchronization-primitives">
<h2>Synchronization primitives<a class="headerlink" href="#synchronization-primitives" title="Link to this heading">#</a></h2>
<p>libuv offers several cross-platform synchronization primitives, which work
largely like their pthreads counterparts:</p>
<ul class="simple">
<li><p><a class="reference external" href="luv/Luv/Mutex/index.html">Luv.Mutex</a> — mutexes</p></li>
<li><p><a class="reference external" href="luv/Luv/Rwlock/index.html">Luv.Rwlock</a> — read-write locks</p></li>
<li><p><a class="reference external" href="luv/Luv/Semaphore/index.html">Luv.Semaphore</a> — semaphores</p></li>
<li><p><a class="reference external" href="luv/Luv/Condition/index.html">Luv.Condition</a> — condition variables</p></li>
<li><p><a class="reference external" href="luv/Luv/Barrier/index.html">Luv.Barrier</a> — barriers</p></li>
<li><p><a class="reference external" href="luv/Luv/Once/index.html">Luv.Once</a> — once-only barriers</p></li>
<li><p><a class="reference external" href="luv/Luv/TLS/index.html">Luv.TLS</a> — thread-local storage</p></li>
</ul>
<p>Here’s an example that uses a mutex to wait for a thread to finish its work:</p>
<p class="rubric"><a class="reference external" href="https://github.com/aantron/luv/blob/master/example/mutex.ml">mutex.ml</a></p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
<span class="linenos"> 2</span>  <span class="k">let</span> <span class="n">mutex</span> <span class="o">=</span> <span class="nn">Luv</span><span class="p">.</span><span class="nn">Mutex</span><span class="p">.</span><span class="n">init</span> <span class="bp">()</span> <span class="o">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">get_ok</span> <span class="k">in</span>
<span class="hll"><span class="linenos"> 3</span>  <span class="nn">Luv</span><span class="p">.</span><span class="nn">Mutex</span><span class="p">.</span><span class="n">lock</span> <span class="n">mutex</span><span class="o">;</span>
</span><span class="linenos"> 4</span>
<span class="hll"><span class="linenos"> 5</span>  <span class="n">ignore</span> <span class="o">@@</span> <span class="nn">Luv</span><span class="p">.</span><span class="nn">Thread</span><span class="p">.</span><span class="n">create</span> <span class="k">begin</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="linenos"> 6</span>    <span class="nn">Luv</span><span class="p">.</span><span class="nn">Time</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">1000</span><span class="o">;</span>
<span class="hll"><span class="linenos"> 7</span>    <span class="nn">Luv</span><span class="p">.</span><span class="nn">Mutex</span><span class="p">.</span><span class="n">unlock</span> <span class="n">mutex</span>
</span><span class="linenos"> 8</span>  <span class="k">end</span><span class="o">;</span>
<span class="linenos"> 9</span>
<span class="hll"><span class="linenos">10</span>  <span class="nn">Luv</span><span class="p">.</span><span class="nn">Mutex</span><span class="p">.</span><span class="n">lock</span> <span class="n">mutex</span><span class="o">;</span>
</span><span class="linenos">11</span>  <span class="n">print_endline</span> <span class="s2">&quot;Worker finished&quot;</span>
</pre></div>
</div>
</section>
<section id="inter-thread-communication">
<h2>Inter-thread communication<a class="headerlink" href="#inter-thread-communication" title="Link to this heading">#</a></h2>
<p>In addition to all the synchronization primitives listed above, libuv offers one
more method of inter-thread communication. If you have a thread that is blocked
inside <a class="reference external" href="luv/Luv/Loop/index.html#val-run">Luv.Loop.run</a>, as your program’s main
thread typically would be, you can cause <a class="reference external" href="luv/Luv/Loop/index.html#val-run">Luv.Loop.run</a> to “wake up” and run a callback using <a class="reference external" href="luv/Luv/Async/index.html">Luv.Async</a>:</p>
<p class="rubric"><a class="reference external" href="https://github.com/aantron/luv/blob/master/example/progress.ml">progress.ml</a></p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
<span class="linenos"> 2</span>  <span class="k">let</span> <span class="n">progress</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">.</span> <span class="k">in</span>
<span class="linenos"> 3</span>  <span class="k">let</span> <span class="n">show_progress</span> <span class="bp">()</span> <span class="o">=</span>
<span class="linenos"> 4</span>    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%i%%</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="o">(</span><span class="n">int_of_float</span> <span class="o">(!</span><span class="n">progress</span> <span class="o">*.</span> <span class="mi">100</span><span class="o">.))</span> <span class="k">in</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>  <span class="k">let</span> <span class="n">notification</span> <span class="o">=</span>
<span class="hll"><span class="linenos"> 7</span>    <span class="nn">Luv</span><span class="p">.</span><span class="nn">Async</span><span class="p">.</span><span class="n">init</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">show_progress</span> <span class="bp">()</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">get_ok</span> <span class="k">in</span>
</span><span class="linenos"> 8</span>
<span class="linenos"> 9</span>  <span class="k">let</span> <span class="k">rec</span> <span class="n">do_work</span> <span class="n">total</span> <span class="n">n</span> <span class="o">=</span>
<span class="linenos">10</span>    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">total</span> <span class="k">then</span>
<span class="linenos">11</span>      <span class="bp">()</span>
<span class="linenos">12</span>    <span class="k">else</span> <span class="k">begin</span>
<span class="linenos">13</span>      <span class="nn">Luv</span><span class="p">.</span><span class="nn">Time</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">1000</span><span class="o">;</span>
<span class="linenos">14</span>      <span class="n">progress</span> <span class="o">:=</span> <span class="n">float_of_int</span> <span class="o">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">/.</span> <span class="n">float_of_int</span> <span class="n">total</span><span class="o">;</span>
<span class="hll"><span class="linenos">15</span>      <span class="n">ignore</span> <span class="o">(</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">Async</span><span class="p">.</span><span class="n">send</span> <span class="n">notification</span><span class="o">);</span>
</span><span class="linenos">16</span>      <span class="n">do_work</span> <span class="n">total</span> <span class="o">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
<span class="linenos">17</span>    <span class="k">end</span>
<span class="linenos">18</span>  <span class="k">in</span>
<span class="linenos">19</span>
<span class="linenos">20</span>  <span class="k">let</span> <span class="n">finished</span> <span class="o">_</span> <span class="o">=</span>
<span class="hll"><span class="linenos">21</span>    <span class="nn">Luv</span><span class="p">.</span><span class="nn">Handle</span><span class="p">.</span><span class="n">close</span> <span class="n">notification</span> <span class="n">ignore</span><span class="o">;</span>
</span><span class="linenos">22</span>    <span class="n">print_endline</span> <span class="s2">&quot;Done&quot;</span>
<span class="linenos">23</span>  <span class="k">in</span>
<span class="linenos">24</span>
<span class="hll"><span class="linenos">25</span>  <span class="nn">Luv</span><span class="p">.</span><span class="nn">Thread_pool</span><span class="p">.</span><span class="n">queue_work</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">do_work</span> <span class="mi">3</span> <span class="mi">0</span><span class="o">)</span> <span class="n">finished</span><span class="o">;</span>
</span><span class="linenos">26</span>
<span class="linenos">27</span>  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Luv</span><span class="p">.</span><span class="nn">Loop</span><span class="p">.</span><span class="n">run</span> <span class="bp">()</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">)</span>
</pre></div>
</div>
<p>Technically, this is a form of <em>inter-loop</em> communication, since the
notification is received by a loop, in whatever thread happens to be calling
<a class="reference external" href="luv/Luv/Loop/index.html#val-run">Luv.Loop.run</a> for that loop. The notification
can be sent by any thread.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The callback may be invoked immediately after <a class="reference external" href="luv/Luv/Async/index.html#val-send">Luv.Async.send</a> is called, or after some time. libuv may
combine multiple calls to <a class="reference external" href="luv/Luv/Async/index.html#val-send">Luv.Async.send</a> into one callback call.</p>
</div>
</section>
<section id="multiple-event-loops">
<h2>Multiple event loops<a class="headerlink" href="#multiple-event-loops" title="Link to this heading">#</a></h2>
<p>You can run multiple libuv event loops. A complex application might have several
“primary” threads, each running its own event loop, several ordinary worker
threads, and be communicating with some external processes, some of which might
also be running libuv.</p>
<p>To run multiple event loops, create them with <a class="reference external" href="luv/Luv/Loop/index.html#val-init">Luv.Loop.init</a>. Then, pass them as the <code class="docutils literal notranslate"><span class="pre">?loop</span></code> arguments to the
various Luv APIs. Here are some sample calls:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">secondary_loop</span> <span class="o">=</span> <span class="nn">Luv</span><span class="p">.</span><span class="nn">Loop</span><span class="p">.</span><span class="n">init</span> <span class="bp">()</span> <span class="o">|&gt;</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="nn">Result</span><span class="p">.</span><span class="n">get_ok</span> <span class="k">in</span> <span class="c">(* ... *)</span>

<span class="n">ignore</span> <span class="o">@@</span> <span class="nn">Luv</span><span class="p">.</span><span class="nn">Loop</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">loop</span><span class="o">:</span><span class="n">secondary_loop</span> <span class="bp">()</span><span class="o">;</span>

<span class="nn">Luv</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="n">open_</span> <span class="o">~</span><span class="n">loop</span><span class="o">:</span><span class="n">secondary_loop</span> <span class="s2">&quot;foo&quot;</span> <span class="o">[`</span><span class="nc">RDONLY</span><span class="o">]</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="c">(* ... *)</span><span class="o">)</span>
</pre></div>
</div>
<p>In the future, Luv may lazily create a loop on demand in each thread when it
first tries to use libuv, store a reference to it in a TLS key, and pass that as
the default value of the <code class="docutils literal notranslate"><span class="pre">?loop</span></code> argument throughout the API.</p>
</section>
<section id="ocaml-runtime-lock">
<h2>OCaml runtime lock<a class="headerlink" href="#ocaml-runtime-lock" title="Link to this heading">#</a></h2>
<p>Luv integrates libuv with the OCaml runtime lock. This means that, as in any
other OCaml program, two threads cannot be running OCaml code at the same time.
However, Luv releases the lock when calling a potentially-blocking libuv API, so
that other threads can run while the calling thread is blocked. In particular,
the lock is released during calls to <a class="reference external" href="luv/Luv/Loop/index.html#val-run">Luv.Loop.run</a>, which means that other threads can run in between
when you make a call to a <em>non-blocking</em> API, and when its callback is called by
libuv.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="processes.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Processes</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="networking.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Networking</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2012-2016, Nikhil Marathe, 2014-2020 libuv contributors, 2020-2023 Anton Bachin
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Threads</a><ul>
<li><a class="reference internal" href="#starting-and-waiting">Starting and waiting</a></li>
<li><a class="reference internal" href="#libuv-thread-pool">libuv thread pool</a></li>
<li><a class="reference internal" href="#synchronization-primitives">Synchronization primitives</a></li>
<li><a class="reference internal" href="#inter-thread-communication">Inter-thread communication</a></li>
<li><a class="reference internal" href="#multiple-event-loops">Multiple event loops</a></li>
<li><a class="reference internal" href="#ocaml-runtime-lock">OCaml runtime lock</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>